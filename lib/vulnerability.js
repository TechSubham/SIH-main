import clientPromise, { checkConnection } from './db';

export async function getvulnerability() {
  try {
    const isConnected = await checkConnection();
    if (!isConnected) {
      console.log("fuck");
      throw new Error("Failed to connect to MongoDB");
    }

    const client = await clientPromise;
    const dbName = "qubit-arvrs"; // Verify this is correct
    const collectionName = "vulnerability"; // Verify this is correct
    
    console.log(`Attempting to query database: ${dbName}, collection: ${collectionName}`);
    
    const db = client.db(dbName);

    const vulnerability = await db
      .collection(collectionName)
      .find({})
      .project({ cve_id: 1, severity: 1, description: 1 })
      .toArray();

    console.log(`Retrieved ${vulnerability.length} vulnerability`);
    
    if (vulnerability.length === 0) {
      console.log("No vulnerability found. Here are the available collections:");
      const collections = await db.listCollections().toArray();
      console.log(collections.map(c => c.name));
    }

    return vulnerability;
  } catch (error) {
    console.error('Error in getvulnerability:', error);
    throw error;
  }
}