export const dynamic = 'force-dynamic';

import { MongoClient } from "mongodb";

const uri =
  "mongodb+srv://qubit-root:f2NqL1WzplvqLbE3@qubit-arvrs.lfzfu.mongodb.net/?retryWrites=true&w=majority&appName=qubit-arvrs";
const db = "arvrs";

let client;
let clientPromise;

if (process.env.NODE_ENV === "development") {
  // In development mode, use a global variable so that the value
  // is preserved across module reloads caused by HMR (Hot Module Replacement).
  if (!global._mongoClientPromise) {
    client = new MongoClient(uri);
    global._mongoClientPromise = client.connect();
  }
  clientPromise = global._mongoClientPromise;
} else {
  // In production mode, it's best to not use a global variable.
  client = new MongoClient(uri);
  clientPromise = client.connect();
}

export async function GET(request) {
  try {
    const client = await clientPromise;
    const database = client.db(db);
    const collection = database.collection("vulnerability");

    const vulnerabilities = await collection
      .find({ severity: { $ne: null } })
      .project({
        cve_id: 1,
        published_date: 1,
        description: 1,
        severity: 1,
        _id: 0,
        summary: 1,
        org_link: 1,
        recommendations: 1,
        affected_products: 1,
      })
      .sort({ published_date: -1 })
      .toArray();

    return new Response(JSON.stringify(vulnerabilities), {
      headers: { "Content-Type": "application/json" },
      status: 200,
    });
  } catch (error) {
    console.error("Error in API route:", error);
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { "Content-Type": "application/json" },
      status: 500,
    });
  }
}